create table 游客信息
(
游客ID int primary key,
姓名 varchar(50) not null,
身份证号码 char(18) not null,
联系方式 varchar(20) not null,
入园时间 datetime not null,
离园时间 datetime,
入园方式 varchar(10) not null  check (入园方式 in ('线上预约','现场购票'))
);

create table 预约记录
(
预约编号 int primary key,
游客ID int not null,
预约时间 datetime not null,
入园时段 varchar(20) not null check(入园时段 in('8:00-12:00','12:00-17:00')),
同行人数 int not null,
预约状态 varchar(10) not null check(预约状态 in ('已确认','已取消','已完成')),
购票金额 numeric(4,1) not null,
支付状态 varchar(10) not null,
foreign key (游客ID) references 游客信息(游客ID)
);

create table 流量控制信息
(
信息ID int primary key,
当前状态 varchar(10) not null check (当前状态 in ('正常','预警','限流')),
实时在园人数 int not null,
区域编号 int not null,
日最大承载量 int not null,
预警阈值 int
);


create table 游客轨迹数据
(
轨迹编号 int primary key,
游客ID int not null,
信息ID int not null,
定位时间 datetime not null,
经度 numeric(9,6) not null,
纬度 numeric(9,6) not null,
是否超出规定路线 char(2) not null,
foreign key (游客ID) references 游客信息(游客ID),
foreign key (信息ID) references 流量控制信息(信息ID)
);


-- 游客入园方式统计视图
CREATE VIEW 游客入园方式统计视图 AS
SELECT 入园方式, COUNT(游客ID) AS 游客数量, DATE_FORMAT(入园时间, '%Y-%m-%d') AS 入园日期
FROM 游客信息
GROUP BY 入园方式, 入园日期;

-- 区域流量预警统计视图
CREATE VIEW 区域流量预警统计视图 AS
SELECT 区域编号, 当前状态, 实时在园人数, 日最大承载量, COUNT(信息ID) AS 预警次数, DATE_FORMAT(NOW(), '%Y-%m-%d') AS 统计日期
FROM 流量控制信息
WHERE 当前状态 IN ('预警', '限流')
GROUP BY 区域编号, 当前状态, 实时在园人数, 日最大承载量;

CREATE VIEW 游客违规轨迹统计视图 
AS  -- 补充AS后缺失的空格，原SQL中AS和SELECT连在一起，存在语法瑕疵
SELECT   t.游客ID,   t.姓名,   COUNT(tr.轨迹编号) AS 违规次数,   tr.区域编号  -- 若确认该列存在，保留；若不存在，替换为实际列名或调整表别名
FROM 游客信息 t
JOIN 游客轨迹数据 tr   ON t.游客ID = tr.游客ID
WHERE tr.是否超出规定路线 = '是'
GROUP BY t.游客ID, t.姓名, tr.区域编号;



-- 插入“游客”和“公园管理员”角色
INSERT INTO roles (id, role_name)
VALUES 
(4, '游客'),
(5, '公园管理员');


-- 插入游客管理业务对应的资源权限（假设当前permissions表最大id为N，需替换为实际最大id+1）
INSERT INTO permissions (id, resource)
VALUES 
-- 替换下方id为实际连续值（例如当前最大id是5，则从6开始）
(16, '游客信息'息,
(17, '预约记录'录,
(18, '流量控制信息'息,
(19, '游客轨迹数据'据,
(20, '游客违规轨迹视图'图;


INSERT INTO role_permissions (role_id, permission_id)
VALUES 
(4, 7),  
(4, 6);  

INSERT INTO role_permissions (role_id, permission_id)
VALUES 
(5, 16),   
(5, 17),   
(5, 18),   
(5, 19),  
(5, 20);  
